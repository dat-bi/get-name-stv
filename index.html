<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh T·∫£i Name Sangtacviet (N√¢ng cao)</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content: center; */ /* Allow scrolling */
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px; /* Increased width */
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .instructions {
            margin-top: 20px;
            font-size: 14px;
            color: #555;
            text-align: left;
        }
        .instructions p {
            margin-bottom: 5px;
        }
        .instructions code {
            background-color: #e9e9e9;
            padding: 2px 5px;
            border-radius: 3px;
        }
        #resultsArea {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }
        #resultsArea p {
            margin: 5px 0;
            font-size: 14px;
        }
        #resultsArea .package-info {
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        #resultsArea .package-info:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì• Tr√¨nh T·∫£i Name Sangtacviet (N√¢ng cao)</h1>
        <input type="text" id="urlInput" placeholder="D√°n URL truy·ªán v√†o ƒë√¢y (v√≠ d·ª•: https://sangtacviet.app/truyen/uukanshu/82614/ten-truyen/)">
        <button id="downloadButton">T·∫£i Names</button>

        <div id="resultsArea">
            <p>Th√¥ng tin c√°c g√≥i name s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y...</p>
        </div>

        <div class="instructions">
            <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
            <p>1. Sao ch√©p URL c·ªßa truy·ªán t·ª´ Sangtacviet (v√≠ d·ª•: <code>https://sangtacviet.app/truyen/uukanshu/82614/ten-truyen/</code>).</p>
            <p>2. D√°n v√†o √¥ ph√≠a tr√™n.</p>
            <p>3. Nh·∫•n n√∫t "T·∫£i Names". C√°c g√≥i name t√¨m th·∫•y s·∫Ω ƒë∆∞·ª£c li·ªát k√™.</p>
            <p>4. M·ªôt t·ªáp <code>.zip</code> ch·ª©a c√°c file name (<code>.txt</code>) t·ª´ t·∫•t c·∫£ c√°c g√≥i s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫£i xu·ªëng.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        const urlInput = document.getElementById('urlInput');
        const downloadButton = document.getElementById('downloadButton');
        const resultsArea = document.getElementById('resultsArea');

        function downloadNames_Sangtacviet(url) {
            resultsArea.innerHTML = "<p>ƒêang x·ª≠ l√Ω URL...</p>";
            if (url.slice(-1) === "/") url = url.slice(0, -1);

            let host = url.split('/truyen/')[0]; // V√≠ d·ª•: https://sangtacviet.app
            let params = url.split('/truyen/')[1].split('/'); // V√≠ d·ª•: ["uukanshu", "82614", "ten-truyen"]
            
            let bookhost, bookid;

            if (params.length >= 2) {
                bookhost = params[0]; // V√≠ d·ª•: uukanshu
                bookid = params[1];   // V√≠ d·ª•: 82614
            } else {
                alert("Link kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng mong mu·ªën ƒë·ªÉ tr√≠ch xu·∫•t bookhost v√† bookid!\nC·∫ßn c√≥ d·∫°ng: .../truyen/BOOKHOST/BOOKID/...");
                resultsArea.innerHTML = "<p>L·ªói: Link kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.</p>";
                return;
            }

            if (!bookhost || !bookid) {
                alert("Link sai sai! Kh√¥ng th·ªÉ x√°c ƒë·ªãnh bookhost ho·∫∑c bookid.");
                resultsArea.innerHTML = "<p>L·ªói: Kh√¥ng th·ªÉ x√°c ƒë·ªãnh bookhost ho·∫∑c bookid.</p>";
                return;
            }

            // URL th·ª±c t·∫ø ƒë·∫øn namesys.php
            let actualNamesysUrl = `${host}/namesys.php?host=${bookhost}&book=${bookid}`;
            // URL qua proxy allorigins.win ƒë·ªÉ l·∫•y HTML
            let proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(actualNamesysUrl)}`;

            resultsArea.innerHTML = `<p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´: ${actualNamesysUrl}...</p>`;
            console.log("ƒêang g·ªçi API qua proxy:", proxyUrl);
            console.log("Host g·ªëc:", host);
            console.log("Book Host:", bookhost);
            console.log("Book ID:", bookid);

            fetch(proxyUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`L·ªói HTTP: ${response.status} khi g·ªçi proxy.`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c t·ª´ proxy:", data);
                    if (!data.contents) {
                        throw new Error("Kh√¥ng t√¨m th·∫•y 'contents' trong d·ªØ li·ªáu tr·∫£ v·ªÅ t·ª´ proxy. Proxy c√≥ th·ªÉ ƒë√£ thay ƒë·ªïi API.");
                    }
                    
                    const htmlString = data.contents;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlString, "text/html");

                    const extractedPackages = [];
                    // Selector cho c√°c div ch·ª©a names, d·ª±a theo style b·∫°n cung c·∫•p
                    const nameDivSelector = 'div[style="white-space:nowrap;overflow:hidden;max-width:140px;max-height:26px;font-size:12px;"]';
                    const nameDivs = doc.querySelectorAll(nameDivSelector);

                    if (nameDivs.length === 0) {
                        resultsArea.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y g√≥i name n√†o trong d·ªØ li·ªáu HTML. C√≥ th·ªÉ selector CSS kh√¥ng ƒë√∫ng ho·∫∑c trang kh√¥ng c√≥ name theo c·∫•u tr√∫c n√†y.</p>";
                        alert("Kh√¥ng t√¨m th·∫•y g√≥i name n√†o ph√π h·ª£p!");
                        return;
                    }
                    
                    resultsArea.innerHTML = `<p>ƒê√£ t√¨m th·∫•y ${nameDivs.length} kh·ªëi d·ªØ li·ªáu c√≥ th·ªÉ l√† name. ƒêang tr√≠ch xu·∫•t...</p>`;

                    nameDivs.forEach((nameDiv, index) => {
                        const namesText = nameDiv.innerText.trim();
                        
                        let packageName = `G√≥i_${index + 1}`; // Default
                        let wordCount = "N/A";
                        let timestamp = "N/A";

                        // T√¨m t√™n g√≥i (node text ph√≠a tr∆∞·ªõc div)
                        let prevNode = nameDiv.previousSibling;
                        while(prevNode && (prevNode.nodeType !== Node.TEXT_NODE || !prevNode.textContent.trim())) {
                            prevNode = prevNode.previousSibling;
                        }
                        if (prevNode && prevNode.textContent.trim()) {
                            packageName = prevNode.textContent.trim();
                        }

                        // T√¨m s·ªë l∆∞·ª£ng t·ª´ (node text ƒë·∫ßu ti√™n ph√≠a sau div)
                        let nextNode = nameDiv.nextSibling;
                        while(nextNode && (nextNode.nodeType !== Node.TEXT_NODE || !nextNode.textContent.trim())) {
                            nextNode = nextNode.nextSibling;
                        }
                        if (nextNode && nextNode.textContent.trim()) {
                            wordCount = nextNode.textContent.trim();
                            
                            // T√¨m timestamp (node text ti·∫øp theo sau wordCount)
                            let tsNode = nextNode.nextSibling;
                            while(tsNode && (tsNode.nodeType !== Node.TEXT_NODE || !tsNode.textContent.trim())) {
                                tsNode = tsNode.nextSibling;
                            }
                            if (tsNode && tsNode.textContent.trim()) {
                                timestamp = tsNode.textContent.trim();
                            }
                        }
                        
                        if (namesText) { // Ch·ªâ th√™m n·∫øu c√≥ n·ªôi dung name
                             extractedPackages.push({
                                packageName,
                                namesText,
                                wordCount,
                                timestamp
                            });
                        }
                    });
                    
                    if (extractedPackages.length === 0) {
                        alert("Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c g√≥i name n√†o c√≥ n·ªôi dung!");
                        resultsArea.innerHTML = "<p>Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c g√≥i name n√†o c√≥ n·ªôi dung!</p>";
                        return;
                    }

                    resultsArea.innerHTML = "<h3>C√°c g√≥i name t√¨m th·∫•y:</h3>";
                    var zip = new JSZip();

                    extractedPackages.forEach(pkg => {
                        resultsArea.innerHTML += `<div class="package-info"><strong>${pkg.packageName}</strong> (${pkg.wordCount} t·ª´, ${pkg.timestamp})</div>`;
                        
                        let text_input = pkg.namesText;
                        if (text_input.startsWith("$")) {
                            text_input = text_input.substring(1);
                        }
                        let processedNames = text_input.split('\n$').join('\n');
                        
                        // T·∫°o t√™n file an to√†n h∆°n
                        let safePackageName = pkg.packageName.replace(/[^a-z0-9_\-\s]/gi, '').trim().replace(/\s+/g, '_');
                        let safeTimestamp = pkg.timestamp.replace(/[:\s]/g, '-');
                        let fileName = `${safePackageName}_${pkg.wordCount}t·ª´_${safeTimestamp}.txt`;
                        
                        zip.file(fileName, processedNames);
                    });

                    if (Object.keys(zip.files).length === 0) {
                        alert("Kh√¥ng c√≥ name n√†o h·ª£p l·ªá ƒë·ªÉ th√™m v√†o file zip.");
                        resultsArea.innerHTML += "<p>Kh√¥ng c√≥ name h·ª£p l·ªá ƒë·ªÉ t·∫°o ZIP.</p>";
                        return;
                    }

                    let fileTimestamp = Math.floor(Date.now() / 1000);
                    zip.generateAsync({ type: "blob" })
                        .then(content => {
                            saveAs(content, `Names_${bookhost}-${bookid}_${fileTimestamp}.zip`);
                            resultsArea.innerHTML += "<p><strong>ƒê√£ t·∫°o v√† t·∫£i xu·ªëng file ZIP!</strong></p>";
                        })
                        .catch(err => {
                            console.error("L·ªói khi t·∫°o file zip:", err);
                            alert("C√≥ l·ªói x·∫£y ra khi t·∫°o file zip.");
                            resultsArea.innerHTML += "<p>L·ªói khi t·∫°o ZIP: " + err.message + "</p>";
                        });
                })
                .catch(error => {
                    console.error("Fetch ho·∫∑c x·ª≠ l√Ω th·∫•t b·∫°i:", error);
                    alert("C√≥ l·ªói x·∫£y ra: " + error.message + "\nVui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.");
                    resultsArea.innerHTML = `<p>L·ªói: ${error.message}</p>`;
                });
        }

        downloadButton.addEventListener('click', function() {
            const url = urlInput.value.trim();
            if (!url) {
                alert("Vui l√≤ng nh·∫≠p URL c·ªßa truy·ªán!");
                resultsArea.innerHTML = "<p>L·ªói: Vui l√≤ng nh·∫≠p URL.</p>";
                return;
            }
            if (!url.includes('/truyen/')) {
                alert("URL kh√¥ng h·ª£p l·ªá. URL ph·∫£i ch·ª©a '/truyen/'.\nV√≠ d·ª•: https://sangtacviet.app/truyen/uukanshu/82614/ten-truyen/");
                resultsArea.innerHTML = "<p>L·ªói: URL kh√¥ng h·ª£p l·ªá.</p>";
                return;
            }
            downloadNames_Sangtacviet(url);
        });
    </script>
</body>
</html>
